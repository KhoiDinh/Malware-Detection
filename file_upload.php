<?php

echo <<<TEST
<html>
<title> Upload Scanning File </title>

    <body>
        <header id = "header">
             <h1 align="center">Check Files</h1>
            <div></div>
             <p align="center"> Please enter in the file that you want to scan</p>
        </header>

        <form action="file_upload.php" method="post" enctype="multipart/form-data">
    Select file to scan:
            <input type="file" name="file" required>
            <input type="submit" value="Upload"  name="submitFile">
            </form>
        </form>
    <form>
        <input type="submit" formaction="malware_upload.php" value="Go to Malware Uploads" />
        <input type="submit" formaction="CreateAdmin.php" value="Admin Login" />
    </form>
TEST;

require_once 'DBLogin.php';


if($_FILES)
{
    $fileGood = "";
    $fileGood = checkFile();

    $entire = "";
    $entire = readContent($fileGood);

    $conn = "";
    $conn = new mysqli($hn, $un, $pw, $db);
    if($conn -> connect_error) die($conn->connect_error);
    $entire = chooseSanitization($conn,$entire,$_FILES['file']['type']);

    $rows = "";
    $rows = getMalware($conn);

    $none ="";
    echo "Malware's found: <br>";

    retrieveMalware($rows,$entire);

    $conn->close();
}

echo <<< END
</body></html>
END;

function chooseSanitization($connection,$string, $fileType)
{
    if(!is_object($connection) || !is_string($string) || !is_string($fileType))
    {
        echo "Can't scan file. <br>";
        exit();
    }
    if ($fileType === 'text/plain')
    {
        return mysql_entities_fix_string($connection,$string);
    }
    else
    {
        return mysql_fix_string($connection,$string);
    }
}

function mysql_entities_fix_string($connection, $string)
{
    if(!is_object($connection) || !is_string($string))
    {
        echo "Can't identify upload <br>";
        exit();
    }
    return htmlentities(mysql_fix_string($connection, $string));
}
function mysql_fix_string($connection, $string)
{
    if(!is_object($connection) || !is_string($string))
    {
        echo "Can't identify upload <br>";
        exit();
    }
    if (get_magic_quotes_gpc()) $string = stripslashes($string);
    return $connection->real_escape_string($string);
}

function checkFile()
{
    $fileName = "";
    $fileName = $_FILES['file']['tmp_name'];
    return $fileName;
}

function readContent($file)
{
    if(!is_string($file))
    {
        echo "Can't read file <br>";
        exit();
    }
    $hold = "";
    $file2 = "";
    $file2 = fopen($file,"rb") or exit("Unable to open file!");
    $hold = $hold . fread($file2,filesize($_FILES['file']['tmp_name'])); //IS THIS OK?
    fclose($file2);
    return $hold;
}

function getMalware($conn)
{
    if(!is_object($conn))
    {
        echo "Can't find matches <br>";
        exit();
    }
    $getRecord = "";
    $getRecord = "select * from malwarelist;";

    $adminResult = "";

    $adminResult = $conn -> query($getRecord);
    return $adminResult;
}

function retrieveMalware($adminResult,$entire)
{
    if(!is_object($adminResult) || !is_string($entire))
    {
        echo "Can't get matches <br>";
        exit();
    }
    $none ="";
    $rows = "";
    $rows = $adminResult->num_rows;
    for($j=0; $j<$rows; ++$j) {
        $adminResult->data_seek($j);
        $row = "";
        $row = $adminResult->fetch_array(MYSQLI_ASSOC);

        if (strpos($entire, $row['sequence']) !== false)
        {
            echo $row['malwareName']. ": ". $row['sequence']. "<br>";
            $none = $row['malwareName']. ": ". $row['sequence'];
        }
    }

    if($none === "")
    {
        echo "None" . "<br>";
    }

    $adminResult->close();
}

?>