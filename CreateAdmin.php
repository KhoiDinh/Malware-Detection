<?php
session_start();
require_once 'DBLogin.php';
echo <<< MFILE
<html>
<title> Create Admin </title>
<body>
    <header id = "header">
        <h1 align="center">Admin Login</h1>
        <p align="center"> Sign in to be able to upload malware files.</p>
    </header>


    <form method="post" enctype="multipart/form-data" action="CreateAdmin.php">

        <form method="post" enctype="multipart/form-data">
            <div >
                <label for="username"><b>Username</b></label>
                <input type="text" placeholder="Username" name="username" required>
            </div>
            <div >
                <label for="password"><b>Password</b></label>
                <input type="password" placeholder="Password" name="password" required>
            </div>

            <input type="submit" value="Login" name="submit">
        </form>
    </form>

    <form>
        <input type="submit" formaction="file_upload.php" value="Go to File Uploads" />
        <input type="submit" formaction="malware_upload.php" value="Upload Malware File" />
    </form>
MFILE;

if(isset($_POST['submit']) && isset($_COOKIE['token']))
{
    if(isset($_SESSION['check']))
    {
        echo "Admin already signed in.<br>";
        exit();
    }
}

if($_POST)
{
    $conn ="";
	$conn = new mysqli($hn, $un, $pw, $db);

	if ($conn->connect_error) die($conn->connect_error);

	$check ="";
    $check = "select * from admin;";
    $hold ="";
    $hold = $conn->query($check);

    $userNameEntry = "";
    $passEntry ="";
    $userNameEntry = $_POST['username'];
    $passEntry = $_POST['password'];

    $boole="";
    $boole = checkAccount($hold, $userNameEntry, $passEntry);

    if($boole === true)
    {
        startSession($userNameEntry);
        echo "You have been signed in as an admin.<br>";
        //header('Location: main_page.php');
    }
    else
    {
        echo "Incorrect login credentials. <br>";
        exit();
    }
	$conn->close();
}

function checkAccount($result, $user, $pass)
{
    if(!is_object($result) || !is_string($user) || !is_string($pass))
    {
        echo "Invalid inputs. Try again";
        exit();
    }
    $resultRows = "";
    $resultRows = $result->num_rows;
    for($j=0; $j<$resultRows; ++$j) {
        $result->data_seek($j);

        $row = "";
        $row = $result->fetch_array(MYSQLI_ASSOC);

        $hashOne = "";
        $hashTwo = "";
        $hashOne = $row['hashOne'];
        $hashTwo = $row['hashTwo'];

        $pass2="";
        $pass2 = hash('ripemd128', "$hashOne$pass$hashTwo");

        if($user === $row['userName'] && $pass2 === $row['pass'])
        {
           return true;
        }
    }
    return false;
}

function mysql_entities_fix_string($conn, $string)
{
    $stringHold = "";
    $stringHold = stripcslashes($string);
    $stringHold = strip_tags($stringHold);
    return htmlentities(mysql_fix_string($conn, $stringHold));
}

function mysql_fix_string($conn, $string)
{
    if (get_magic_quotes_gpc()) $string = stripslashes($string);
    return $conn->real_escape_string($string);
}

function startSession($string)
{
    if(!is_string($string))
    {
        echo "Can't create session.<br>";
        exit();
    }
    $sessionTime = "";
    $sessionTime = time() + 5*60;

    $cookie_name = "";
    $cookie_name = 'token';

    $cookie_value="";
    $cookie_value = time();

    setcookie($cookie_name, $cookie_value, $sessionTime, "/");

    $_SESSION['admin'] = $string;
    $_SESSION['check'] = hash('ripemd128', $_SERVER['REMOTE_ADDR'] . $_SERVER['HTTP_USER_AGENT'] . $cookie_value);
}

echo "</body></html>";
?>